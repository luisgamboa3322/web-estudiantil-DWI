<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Evaluación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-100">
    <div class="min-h-screen">
        <header class="bg-white shadow-md p-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" th:text="${evaluacion.titulo}">Resultados</h1>
                    <p class="text-sm text-gray-600" th:text="${evaluacion.tipo}">Tipo</p>
                </div>
                <button onclick="window.history.back()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                    Volver
                </button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Historial de Intentos</h2>
                <div id="intentos-container" class="space-y-4">
                    <!-- Los intentos se mostrarán aquí -->
                </div>
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Usar JSON serializado desde el servidor para evitar problemas con Thymeleaf
        const evaluacionData = /*[[${evaluacion}]]*/ {};
        const intentosJson = /*[[${intentosJson}]]*/ '[]';
        
        // Convertir a objetos JavaScript simples
        const evaluacion = {
            id: evaluacionData?.id || null,
            titulo: evaluacionData?.titulo || '',
            tipo: evaluacionData?.tipo || '',
            descripcion: evaluacionData?.descripcion || ''
        };
        
        // Parsear JSON de intentos
        let intentos = [];
        try {
            if (intentosJson && intentosJson !== '[]' && intentosJson.trim() !== '') {
                intentos = JSON.parse(intentosJson);
                console.log('Intentos parseados desde JSON:', intentos);
            } else {
                // Fallback: intentar usar los datos directamente de Thymeleaf
                const intentosData = /*[[${intentos}]]*/ [];
                if (Array.isArray(intentosData) && intentosData.length > 0) {
                    intentos = intentosData.map(intento => ({
                        intentoId: intento?.intentoId || intento?.id || null,
                        numeroIntento: intento?.numeroIntento || null,
                        estado: intento?.estado || null,
                        fechaInicio: intento?.fechaInicio || null,
                        fechaFin: intento?.fechaFin || null,
                        calificacion: intento?.calificacion !== undefined && intento?.calificacion !== null ? Number(intento.calificacion) : null,
                        comentarios: intento?.comentarios || null
                    }));
                    console.log('Intentos obtenidos desde Thymeleaf (fallback):', intentos);
                } else {
                    console.log('No hay intentos disponibles');
                }
            }
        } catch (e) {
            console.error('Error parseando JSON de intentos:', e);
            intentos = [];
        }
        
        console.log('Evaluación cargada:', evaluacion);
        console.log('Intentos cargados:', intentos);
        console.log('Número de intentos:', intentos.length);
        /*]]>*/

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderIntentos();
        });

        function renderIntentos() {
            const container = document.getElementById('intentos-container');
            if (!container) {
                console.error('No se encontró el contenedor de intentos');
                return;
            }
            
            container.innerHTML = '';

            console.log('Renderizando intentos. Total:', intentos.length);
            console.log('Datos de intentos:', JSON.stringify(intentos, null, 2));
            console.log('Tipo de intentos:', typeof intentos, Array.isArray(intentos));

            if (!intentos || !Array.isArray(intentos) || intentos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="file-question" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p class="text-lg font-medium mb-2">No hay intentos registrados</p>
                        <p class="text-sm">Aún no has realizado ningún intento para esta evaluación.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            intentos.forEach((intento, index) => {
                console.log(`Procesando intento ${index + 1}:`, intento);
                
                // Acceder a las propiedades del intento de forma segura
                const calificacionNum = intento.calificacion !== null && intento.calificacion !== undefined 
                    ? parseFloat(intento.calificacion) 
                    : null;
                const comentarios = intento.comentarios || null;
                const estado = intento.estado || 'N/A';
                const numeroIntento = intento.numeroIntento || 'N/A';
                const intentoId = intento.intentoId || intento.id || null;
                
                const estadoClass = {
                    'EN_PROGRESO': 'bg-yellow-100 text-yellow-600',
                    'COMPLETADO': 'bg-blue-100 text-blue-600',
                    'EXPIRADO': 'bg-red-100 text-red-600',
                    'CALIFICADO': 'bg-green-100 text-green-600'
                }[estado] || 'bg-gray-100 text-gray-600';

                // Formatear fechas de forma segura (parsear desde formato ISO o array)
                let fechaInicioStr = 'Fecha no disponible';
                let fechaFinStr = null;
                
                if (intento.fechaInicio) {
                    try {
                        // Manejar diferentes formatos de fecha
                        let fechaInicio;
                        if (Array.isArray(intento.fechaInicio)) {
                            // Formato array [año, mes, día, hora, minuto, segundo]
                            const [year, month, day, hour, minute, second] = intento.fechaInicio;
                            fechaInicio = new Date(year, month - 1, day, hour || 0, minute || 0, second || 0);
                        } else if (typeof intento.fechaInicio === 'string') {
                            // Formato string ISO
                            fechaInicio = new Date(intento.fechaInicio);
                        } else {
                            fechaInicio = new Date(intento.fechaInicio);
                        }
                        
                        if (!isNaN(fechaInicio.getTime())) {
                            fechaInicioStr = fechaInicio.toLocaleString('es-ES', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } else {
                            console.warn('Fecha de inicio inválida:', intento.fechaInicio);
                        }
                    } catch (e) {
                        console.error('Error parseando fechaInicio:', e, intento.fechaInicio);
                    }
                }
                
                if (intento.fechaFin) {
                    try {
                        // Manejar diferentes formatos de fecha
                        let fechaFin;
                        if (Array.isArray(intento.fechaFin)) {
                            // Formato array [año, mes, día, hora, minuto, segundo]
                            const [year, month, day, hour, minute, second] = intento.fechaFin;
                            fechaFin = new Date(year, month - 1, day, hour || 0, minute || 0, second || 0);
                        } else if (typeof intento.fechaFin === 'string') {
                            // Formato string ISO
                            fechaFin = new Date(intento.fechaFin);
                        } else {
                            fechaFin = new Date(intento.fechaFin);
                        }
                        
                        if (!isNaN(fechaFin.getTime())) {
                            fechaFinStr = fechaFin.toLocaleString('es-ES', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } else {
                            console.warn('Fecha de fin inválida:', intento.fechaFin);
                        }
                    } catch (e) {
                        console.error('Error parseando fechaFin:', e, intento.fechaFin);
                    }
                }

                const intentoDiv = document.createElement('div');
                intentoDiv.className = 'border border-gray-200 rounded-lg p-4 mb-4';
                intentoDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-800">Intento ${numeroIntento}</h3>
                            <p class="text-sm text-gray-600 mt-1">
                                Iniciado: ${fechaInicioStr}
                                ${fechaFinStr ? `<br>Finalizado: ${fechaFinStr}` : ''}
                            </p>
                        </div>
                        <div class="text-right ml-4">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${estadoClass}">
                                ${estado}
                            </span>
                            ${calificacionNum !== null && !isNaN(calificacionNum) ? `
                                <div class="mt-2">
                                    <span class="text-2xl font-bold ${calificacionNum >= 70 ? 'text-green-600' : calificacionNum >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                                        ${calificacionNum.toFixed(1)}%
                                    </span>
                                </div>
                            ` : estado === 'CALIFICADO' ? `
                                <div class="mt-2">
                                    <span class="text-sm text-gray-500">Calificación pendiente</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${comentarios ? `
                        <div class="bg-gray-50 rounded p-3 mb-3">
                            <p class="text-sm text-gray-700"><strong>Comentarios:</strong> ${comentarios}</p>
                        </div>
                    ` : ''}
                    ${estado === 'CALIFICADO' || estado === 'COMPLETADO' ? `
                        <button onclick="verDetalleIntento(${intentoId || ''})" 
                                class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                            Ver detalles del intento →
                        </button>
                    ` : ''}
                `;
                container.appendChild(intentoDiv);
            });
            
            // Actualizar iconos de Lucide después de agregar los elementos
            lucide.createIcons();
            console.log('Intentos renderizados correctamente');
        }

        function verDetalleIntento(intentoId) {
            // Implementar vista detallada del intento
            alert('Vista detallada del intento (por implementar)');
        }
    </script>
</body>
</html>
