<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Curso: ' + ${curso.nombre}">Detalle del Curso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Dark Mode Support -->
    <link rel="stylesheet" th:href="@{/css/dark-mode.css}">
    <script th:src="@{/js/theme-manager.js}"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-icon {
            width: 24px;
            height: 24px;
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .week-tab {
            transition: all 0.3s ease;
        }

        .week-tab.active {
            background-color: #f97316;
            color: white;
        }

        .week-tab:hover:not(.active) {
            background-color: #fed7aa;
        }

        .material-card,
        .task-card {
            transition: all 0.3s ease;
        }

        .material-card:hover,
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen">
        <!-- Barra de navegación lateral (Sidebar) -->
        <aside id="sidebar"
            class="bg-gray-800 text-white w-64 min-h-screen p-4 flex-col justify-between hidden md:flex transition-all duration-300">
            <div>
                <a href="/student/dashboard"
                    class="flex items-center space-x-2 text-2xl font-bold mb-10 text-orange-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-8 w-8">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>UTP+class</span>
                </a>
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="/student/dashboard"
                                class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-700">
                                <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
                                <span>Cursos</span>
                            </a>
                        </li>
                        <li>
                            <a href="/student/chat"
                                class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-700">
                                <i data-lucide="message-square" class="sidebar-icon"></i>
                                <span>Chat</span>
                            </a>
                        </li>
                        <li>
                            <a href="/student/calendario"
                                class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-700">
                                <i data-lucide="calendar" class="sidebar-icon"></i>
                                <span>Calendario</span>
                            </a>
                        </li>
                        <li>
                            <a href="#"
                                class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-700 rounded-lg transition-colors">
                                <i data-lucide="help-circle" class="sidebar-icon"></i>
                                <span>Ayuda</span>
                            </a>
                        </li>
                        <li>
                            <a href="/student/configuracion"
                                class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-700">
                                <i data-lucide="settings" class="sidebar-icon"></i>
                                <span>Configuración</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div>
                <nav>
                    <ul class="space-y-2 border-t border-gray-700 pt-4 mt-4">
                        <li>
                            <a href="/logout"
                                class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-700 rounded-lg transition-colors">
                                <i data-lucide="log-out" class="sidebar-icon"></i>
                                <span>Cerrar Sesión</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- Contenido principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Cabecera (Header) -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button id="menu-button" class="md:hidden">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                    <button onclick="window.history.back()"
                        class="flex items-center space-x-2 text-sm font-semibold text-orange-500 hover:text-orange-700">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        <span>Volver a cursos</span>
                    </button>
                </div>
                <div class="flex items-center space-x-4 ml-auto">
                    <!-- Dark Mode Toggle -->
                    <label class="theme-toggle" title="Cambiar tema">
                        <input type="checkbox" id="theme-toggle-checkbox">
                        <span class="theme-toggle-slider">
                            <i data-lucide="sun" class="sun-icon"></i>
                            <i data-lucide="moon" class="moon-icon"></i>
                        </span>
                    </label>

                    <button class="relative" id="notifications-btn">
                        <i data-lucide="bell" class="h-6 w-6 text-gray-600"></i>
                        <span
                            class="absolute -top-1 -right-1 h-3 w-3 bg-red-500 rounded-full border-2 border-white hidden"
                            id="notification-badge"></span>
                    </button>
                    <div class="flex items-center space-x-2 cursor-pointer" id="user-menu-btn">
                        <img src="https://placehold.co/40x40/EFEFEF/333333?text=LF" alt="Avatar de usuario"
                            class="w-10 h-10 rounded-full">
                        <div class="text-right hidden sm:block">
                            <p class="font-semibold text-sm" th:text="${studentName}">Luis Francisco</p>
                            <p class="text-xs text-gray-500">Estudiante</p>
                        </div>
                        <i data-lucide="chevron-down" class="h-5 w-5 text-gray-500"></i>
                    </div>
                </div>
            </header>

            <!-- Área de contenido -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-4 sm:p-6 lg:p-8">
                <!-- Información del curso -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800" th:text="${curso.nombre}">Nombre del Curso</h1>
                            <p class="text-gray-600 mt-2" th:text="${curso.descripcion}">Descripción del curso</p>
                            <div class="flex items-center space-x-4 mt-4">
                                <span class="text-sm text-gray-500">
                                    <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                                    Profesor: <span th:text="${curso.profesor.nombre}"
                                        class="font-medium">Profesor</span>
                                </span>
                                <span class="text-sm text-gray-500">
                                    <i data-lucide="tag" class="w-4 h-4 inline mr-1"></i>
                                    Código: <span th:text="${curso.codigo}" class="font-medium">Código</span>
                                </span>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <div class="text-center">
                                    <p class="text-sm text-orange-700">Progreso del curso</p>
                                    <p class="text-2xl font-bold text-orange-600">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navegación por semanas -->
                <div class="bg-white rounded-lg shadow-sm mb-6">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800">Contenido del Curso</h2>
                        <p class="text-gray-600 mt-1">Explora las semanas y accede a materiales y tareas</p>
                    </div>
                    <div class="p-4">
                        <div id="weeks-tabs" class="flex flex-wrap gap-2 mb-6">
                            <!-- Las pestañas de semanas se cargarán dinámicamente -->
                        </div>
                        <div id="week-content" class="min-h-96">
                            <!-- El contenido de la semana se cargará dinámicamente -->
                            <div class="text-center py-12">
                                <i data-lucide="book-open" class="h-16 w-16 text-gray-300 mx-auto mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">Selecciona una semana</h3>
                                <p class="text-gray-500">Haz clic en una semana para ver su contenido</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para entregar tarea -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full p-6 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Entregar Tarea</h3>
                    <button id="close-task-modal" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
                <form id="task-form">
                    <input type="hidden" id="task-id" name="taskId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contenido de la entrega</label>
                        <textarea id="task-content" name="contenido" rows="6"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                            placeholder="Escribe aquí tu respuesta o entrega..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-task"
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                            Entregar Tarea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        lucide.createIcons();

        /*<![CDATA[*/
        let currentCursoId = /*[[${curso.id}]]*/ 1;
        let currentStudentEmail = /*[[${#authentication != null ? #authentication.name : ""}]]*/ '';
        /*]]>*/

        // Elementos del DOM
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        const weeksTabs = document.getElementById('weeks-tabs');
        const weekContent = document.getElementById('week-content');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const closeTaskModal = document.getElementById('close-task-modal');
        const cancelTask = document.getElementById('cancel-task');

        // Lógica para mostrar/ocultar el menú lateral en móviles
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-20');
            sidebar.classList.toggle('w-full');
        });

        // Cargar semanas del curso
        async function loadSemanas() {
            try {
                const response = await fetch(`/student/cursos/${currentCursoId}/semanas`);
                if (response.ok) {
                    const semanas = await response.json();
                    renderWeeksTabs(semanas);
                } else {
                    console.error('Error cargando semanas');
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }

        // Renderizar pestañas de semanas
        function renderWeeksTabs(semanas) {
            weeksTabs.innerHTML = '';
            semanas.forEach((semana, index) => {
                const tab = document.createElement('button');
                tab.className = `week-tab px-4 py-2 rounded-lg font-medium ${index === 0 ? 'active' : ''}`;
                tab.textContent = `Semana ${semana.numeroSemana}`;
                tab.setAttribute('data-semana-id', semana.id);
                tab.onclick = () => selectSemana(semana.id, tab);
                weeksTabs.appendChild(tab);
            });

            // Cargar contenido de la primera semana por defecto
            if (semanas.length > 0) {
                selectSemana(semanas[0].id, weeksTabs.firstChild);
            }
        }

        // Seleccionar una semana
        async function selectSemana(semanaId, tabElement) {
            // Actualizar pestañas activas
            document.querySelectorAll('.week-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            tabElement.classList.add('active');

            // Cargar contenido de la semana
            await loadSemanaContent(semanaId);
        }

        // Cargar contenido de una semana
        async function loadSemanaContent(semanaId) {
            try {
                // Mostrar loading
                weekContent.innerHTML = '<div class="text-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto"></div><p class="mt-4 text-gray-600">Cargando contenido...</p></div>';

                const [materialesResponse, tareasResponse, evaluacionesResponse] = await Promise.all([
                    fetch(`/student/semanas/${semanaId}/materiales`),
                    fetch(`/student/semanas/${semanaId}/tareas`),
                    fetch(`/student/semanas/${semanaId}/evaluaciones`)
                ]);

                const materiales = materialesResponse.ok ? await materialesResponse.json() : [];
                const tareas = tareasResponse.ok ? await tareasResponse.json() : [];
                const evaluaciones = evaluacionesResponse.ok ? await evaluacionesResponse.json() : [];

                renderSemanaContent(materiales, tareas, evaluaciones, semanaId);
            } catch (error) {
                console.error('Error cargando contenido:', error);
                weekContent.innerHTML = '<div class="text-center py-12"><p class="text-red-500">Error cargando el contenido</p></div>';
            }
        }

        // Renderizar contenido de la semana
        async function renderSemanaContent(materiales, tareas, evaluaciones, semanaId) {
            let html = '';

            // Materiales
            if (materiales.length > 0) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                            Material de Estudio
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                materiales.forEach(material => {
                    const hasFile = material.fileName && material.fileName.trim() !== '';
                    html += `
                        <div class="material-card bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${material.nombre}</h4>
                                    ${material.descripcion ? `<p class="text-sm text-gray-600 mt-1">${material.descripcion}</p>` : ''}
                                    <p class="text-xs text-gray-500 mt-2">
                                        Subido: ${new Date(material.fechaCreacion).toLocaleDateString()}
                                    </p>
                                </div>
                                ${hasFile ? `
                                    <button onclick="downloadMaterial(${material.id})"
                                        class="ml-3 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                        <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                        Descargar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            // Tareas
            if (tareas.length > 0) {
                html += `
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="clipboard-check" class="w-5 h-5 mr-2"></i>
                            Tareas
                        </h3>
                        <div class="space-y-4">
                `;

                // Procesar tareas de forma síncrona
                for (const tarea of tareas) {
                    const estadoEntrega = await getEstadoEntrega(tarea.id);
                    const entregada = estadoEntrega.entregada;
                    const calificada = estadoEntrega.calificada;
                    const fechaLimite = new Date(tarea.fechaLimite);
                    const ahora = new Date();
                    const vencida = fechaLimite < ahora;

                    let statusClass = 'bg-gray-100 text-gray-600';
                    let statusText = 'Pendiente';

                    if (entregada) {
                        if (calificada) {
                            statusClass = 'bg-green-100 text-green-600';
                            statusText = `Calificada (${estadoEntrega.calificacion} pts)`;
                        } else {
                            statusClass = 'bg-blue-100 text-blue-600';
                            statusText = 'Entregada';
                        }
                    } else if (vencida) {
                        statusClass = 'bg-red-100 text-red-600';
                        statusText = 'Vencida';
                    }

                    html += `
                        <div class="task-card bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${tarea.titulo}</h4>
                                    ${tarea.descripcion ? `<p class="text-sm text-gray-600 mt-1">${tarea.descripcion}</p>` : ''}
                                    <div class="flex items-center space-x-4 mt-2">
                                        <span class="text-xs text-gray-500">
                                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                            Vence: ${fechaLimite.toLocaleDateString()}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            <i data-lucide="star" class="w-4 h-4 inline mr-1"></i>
                                            Puntos: ${tarea.puntosMaximos}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                    ${!entregada && !vencida ? `
                                        <button onclick="openTaskModal(${tarea.id}, '${tarea.titulo}')"
                                            class="bg-orange-500 text-white px-4 py-2 rounded text-sm hover:bg-orange-600 transition-colors">
                                            Entregar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            // Evaluaciones
            if (evaluaciones.length > 0) {
                html += `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="file-question" class="w-5 h-5 mr-2"></i>
                            Evaluaciones
                        </h3>
                        <div class="space-y-4">
                `;

                for (const evaluacion of evaluaciones) {
                    const intentos = await getIntentosEvaluacion(evaluacion.id);
                    const intentosCompletados = intentos.filter(i => i.estado === 'COMPLETADO' || i.estado === 'CALIFICADO');
                    const intentosEnProgreso = intentos.filter(i => i.estado === 'EN_PROGRESO');
                    const puedeIniciar = evaluacion.estado === 'PUBLICADA' || evaluacion.estado === 'EN_CURSO';

                    // Parsear fechas correctamente (formato ISO de LocalDateTime: "2024-01-15T10:30:00")
                    let fechaInicio, fechaLimite;
                    try {
                        // Jackson puede serializar LocalDateTime como array [año, mes, día, hora, minuto, segundo] o como string
                        if (Array.isArray(evaluacion.fechaInicio)) {
                            // Formato array: [2024, 1, 15, 10, 30, 0]
                            fechaInicio = new Date(evaluacion.fechaInicio[0], evaluacion.fechaInicio[1] - 1,
                                evaluacion.fechaInicio[2], evaluacion.fechaInicio[3] || 0,
                                evaluacion.fechaInicio[4] || 0, evaluacion.fechaInicio[5] || 0);
                        } else if (typeof evaluacion.fechaInicio === 'string') {
                            // Formato string ISO: "2024-01-15T10:30:00" o "2024-01-15T10:30"
                            let fechaStr = evaluacion.fechaInicio;
                            // Asegurar que tenga segundos si no los tiene
                            if (fechaStr.length === 16) {
                                fechaStr += ':00';
                            }
                            fechaInicio = new Date(fechaStr);
                        } else {
                            fechaInicio = new Date(evaluacion.fechaInicio);
                        }

                        if (Array.isArray(evaluacion.fechaLimite)) {
                            fechaLimite = new Date(evaluacion.fechaLimite[0], evaluacion.fechaLimite[1] - 1,
                                evaluacion.fechaLimite[2], evaluacion.fechaLimite[3] || 0,
                                evaluacion.fechaLimite[4] || 0, evaluacion.fechaLimite[5] || 0);
                        } else if (typeof evaluacion.fechaLimite === 'string') {
                            let fechaStr = evaluacion.fechaLimite;
                            if (fechaStr.length === 16) {
                                fechaStr += ':00';
                            }
                            fechaLimite = new Date(fechaStr);
                        } else {
                            fechaLimite = new Date(evaluacion.fechaLimite);
                        }

                        // Validar que las fechas sean válidas
                        if (isNaN(fechaInicio.getTime()) || isNaN(fechaLimite.getTime())) {
                            console.error('Fechas inválidas:', evaluacion.fechaInicio, evaluacion.fechaLimite);
                            throw new Error('Fechas inválidas');
                        }
                    } catch (e) {
                        console.error('Error parseando fechas:', e, evaluacion);
                        // Usar fechas por defecto (hoy y mañana) para que no se rompa la UI
                        fechaInicio = new Date();
                        fechaLimite = new Date();
                        fechaLimite.setDate(fechaLimite.getDate() + 1);
                    }

                    const ahora = new Date();
                    // Comparar fechas correctamente
                    const disponible = ahora >= fechaInicio && ahora <= fechaLimite;
                    const aunNoInicia = ahora < fechaInicio;
                    const yaVencida = ahora > fechaLimite;

                    let statusClass = 'bg-gray-100 text-gray-600';
                    let statusText = 'No disponible';
                    let puedeRealizar = false;

                    if (evaluacion.estado === 'CERRADA') {
                        statusClass = 'bg-red-100 text-red-600';
                        statusText = 'Cerrada';
                    } else if (aunNoInicia) {
                        statusClass = 'bg-yellow-100 text-yellow-600';
                        statusText = `Disponible desde ${fechaInicio.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                    } else if (yaVencida) {
                        statusClass = 'bg-red-100 text-red-600';
                        statusText = 'Vencida';
                    } else if (intentosCompletados.length >= evaluacion.intentosMaximos) {
                        statusClass = 'bg-blue-100 text-blue-600';
                        statusText = `Completada (${intentosCompletados.length}/${evaluacion.intentosMaximos} intentos)`;
                    } else if (intentosEnProgreso.length > 0) {
                        statusClass = 'bg-yellow-100 text-yellow-600';
                        statusText = 'En progreso';
                        puedeRealizar = true;
                    } else if (puedeIniciar && disponible) {
                        statusClass = 'bg-green-100 text-green-600';
                        statusText = `Disponible (${intentosCompletados.length}/${evaluacion.intentosMaximos} intentos)`;
                        puedeRealizar = true;
                    } else if (puedeIniciar && !yaVencida && !aunNoInicia) {
                        // Si está publicada y no está vencida ni pendiente, permitir iniciar
                        statusClass = 'bg-green-100 text-green-600';
                        statusText = 'Disponible';
                        puedeRealizar = true;
                    }

                    html += `
                        <div class="task-card bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${evaluacion.titulo}</h4>
                                    <span class="text-sm text-gray-500">${evaluacion.tipo} - ${evaluacion.puntosMaximos} pts</span>
                                    ${evaluacion.descripcion ? `<p class="text-sm text-gray-600 mt-1">${evaluacion.descripcion}</p>` : ''}
                                    <div class="flex items-center space-x-4 mt-2">
                                        <span class="text-xs text-gray-500">
                                            <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                            Disponible: ${!isNaN(fechaInicio.getTime()) ? fechaInicio.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Fecha inválida'} - ${!isNaN(fechaLimite.getTime()) ? fechaLimite.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Fecha inválida'}
                                        </span>
                                        ${evaluacion.tiempoLimiteMinutos ? `
                                            <span class="text-xs text-gray-500">
                                                <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i>
                                                Tiempo: ${evaluacion.tiempoLimiteMinutos} min
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                    ${puedeRealizar ? `
                                        <button onclick="iniciarEvaluacion(${evaluacion.id}, ${intentosEnProgreso.length > 0 ? intentosEnProgreso[0].id : 'null'})"
                                            class="bg-orange-500 text-white px-4 py-2 rounded text-sm hover:bg-orange-600 transition-colors">
                                            ${intentosEnProgreso.length > 0 ? 'Continuar' : 'Iniciar'}
                                        </button>
                                    ` : ''}
                                    ${intentosCompletados.length > 0 ? `
                                        <button onclick="verResultados(${evaluacion.id})"
                                            class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors">
                                            Ver Resultados
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            if (materiales.length === 0 && tareas.length === 0 && evaluaciones.length === 0) {
                html = `
                    <div class="text-center py-12">
                        <i data-lucide="book-open" class="h-16 w-16 text-gray-300 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Esta semana no tiene contenido</h3>
                        <p class="text-gray-500">El profesor aún no ha agregado materiales o tareas</p>
                    </div>
                `;
            }

            weekContent.innerHTML = html;
            lucide.createIcons();
        }

        // Descargar material
        async function downloadMaterial(materialId) {
            try {
                const response = await fetch(`/student/materiales/${materialId}/download`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'material'; // El nombre se puede obtener del header
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    console.error('Error descargando el material:', response.status);
                    alert('Error descargando el material');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        }

        // Obtener estado de entrega de tarea
        async function getEstadoEntrega(tareaId) {
            try {
                const response = await fetch(`/student/tareas/${tareaId}/entrega`);
                if (response.ok) {
                    return await response.json();
                }
                return { entregada: false };
            } catch (error) {
                console.error('Error obteniendo estado:', error);
                return { entregada: false };
            }
        }

        // Abrir modal de tarea
        function openTaskModal(tareaId, titulo) {
            document.getElementById('task-id').value = tareaId;
            document.getElementById('task-content').value = '';
            taskModal.classList.remove('hidden');
        }

        // Cerrar modal de tarea
        function closeTaskModalFunc() {
            taskModal.classList.add('hidden');
        }

        // Event listeners
        closeTaskModal.addEventListener('click', closeTaskModalFunc);
        cancelTask.addEventListener('click', closeTaskModalFunc);

        taskModal.addEventListener('click', (e) => {
            if (e.target === taskModal) {
                closeTaskModalFunc();
            }
        });

        // Enviar tarea
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tareaId = document.getElementById('task-id').value;
            const contenido = document.getElementById('task-content').value;

            if (!contenido.trim()) {
                alert('Por favor escribe algo en tu entrega');
                return;
            }

            try {
                const response = await fetch(`/student/tareas/${tareaId}/entregar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contenido })
                });

                if (response.ok) {
                    alert('Tarea entregada exitosamente');
                    closeTaskModalFunc();
                    // Recargar el contenido de la semana actual
                    const activeTab = document.querySelector('.week-tab.active');
                    if (activeTab) {
                        const semanaId = activeTab.getAttribute('data-semana-id');
                        loadSemanaContent(semanaId);
                    }
                } else {
                    const error = await response.text();
                    alert('Error: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        });

        // Obtener intentos de evaluación
        async function getIntentosEvaluacion(evaluacionId) {
            try {
                const response = await fetch(`/student/evaluaciones/${evaluacionId}/intentos`);
                if (response.ok) {
                    return await response.json();
                }
                return [];
            } catch (error) {
                console.error('Error obteniendo intentos:', error);
                return [];
            }
        }

        // Iniciar evaluación
        async function iniciarEvaluacion(evaluacionId, intentoId) {
            try {
                if (intentoId && intentoId !== 'null') {
                    // Continuar intento existente
                    window.location.href = `/student/evaluacion/${intentoId}`;
                } else {
                    // Iniciar nuevo intento
                    const response = await fetch(`/student/evaluaciones/${evaluacionId}/iniciar`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const intento = await response.json();
                        window.location.href = `/student/evaluacion/${intento.id}`;
                    } else {
                        const error = await response.text();
                        alert('Error: ' + error);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        }

        // Ver resultados
        function verResultados(evaluacionId) {
            window.location.href = `/student/evaluacion/resultados/${evaluacionId}`;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadSemanas();
        });
    </script>
</body>

</html>